# =========================
# ğŸ¾ TENNIS SHAP PIPELINE
# =========================

import pandas as pd
import shap
import xgboost as xgb
import matplotlib.pyplot as plt
import numpy as np
import json

# --- 1ï¸âƒ£ Veri YÃ¼kleme ---
# JSON dosyasÄ±nÄ± oku
with open("tennis_ml_dataset.json", "r", encoding="utf-8") as f:
    data = json.load(f)

df = pd.DataFrame(data)

print(f"Toplam maÃ§ sayÄ±sÄ±: {len(df)}")
print(f"Toplam Ã¶zellik sayÄ±sÄ±: {len(df.columns)}")

# --- 2ï¸âƒ£ Ã–n Ä°ÅŸleme ---
# Gereksiz veya non-numeric sÃ¼tunlarÄ± Ã§Ä±kar
drop_cols = [
    "event_id", "match_date", "home_player_name", "away_player_name",
    "home_country", "away_country", "home_plays", "away_plays",
    "ground_type", "tournament_name"
]
df = df.drop(columns=[c for c in drop_cols if c in df.columns], errors="ignore")

# Hedef deÄŸiÅŸken (winner)
y = df["winner"].astype(int)
X = df.drop(columns=["winner"], errors="ignore")

# Sadece sayÄ±sal veriler
X = X.select_dtypes(include=["number"]).fillna(0)

# --- 3ï¸âƒ£ Model EÄŸitimi (XGBoost) ---
model = xgb.XGBClassifier(
    n_estimators=300,
    max_depth=6,
    learning_rate=0.05,
    subsample=0.8,
    colsample_bytree=0.8,
    random_state=42
)

model.fit(X, y)

# --- 4ï¸âƒ£ SHAP Analizi ---
explainer = shap.TreeExplainer(model)
shap_values = explainer.shap_values(X)

# --- 5ï¸âƒ£ Global SHAP Analizi ---
plt.figure(figsize=(10, 6))
shap.summary_plot(shap_values, X, plot_type="bar", show=False)
plt.title("Tenis Maci Tahmin Modeli - Ozellik Etkileri (Global SHAP)")
plt.tight_layout()
plt.show(

# --- 6ï¸âƒ£ DetaylÄ± SHAP Analizi (DaÄŸÄ±lÄ±m GrafiÄŸi) ---
plt.figure(figsize=(10, 6))
shap.summary_plot(shap_values, X, show=False)
plt.title("SHAP Feature Impact Distribution")
plt.tight_layout()
plt.show()

# --- 7ï¸âƒ£ Tek MaÃ§ (Local) AÃ§Ä±klama Ã–rneÄŸi ---
sample_index = np.random.randint(0, len(X))
print(f"Ã–rnek maÃ§: index {sample_index}")
shap.force_plot(
    explainer.expected_value,
    shap_values[sample_index, :],
    X.iloc[sample_index, :],
    matplotlib=True
)


# --- 8ï¸âƒ£ SHAP Ã–nem Tablosu (Text Output) ---

import pandas as pd
import numpy as np

# Ortalama mutlak SHAP deÄŸerlerini hesapla
shap_importance = np.abs(shap_values).mean(axis=0)

# Ã–zellik isimleriyle eÅŸleÅŸtir
importance_df = pd.DataFrame({
    "Feature": X.columns,
    "Mean_SHAP_Value": shap_importance
})

# Ã–nem sÄ±rasÄ±na gÃ¶re azalan biÃ§imde sÄ±rala
importance_df = importance_df.sort_values(by="Mean_SHAP_Value", ascending=False)

# Ä°lk 20 Ã¶zelliÄŸi gÃ¶ster
print("\nSHAP Onem Dereceleri (Ilk 20 Ozellik):\n")
print(importance_df.head(20).to_string(index=False))
