<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tenis Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes slide {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }
    .animate-slide {
      animation: slide 1.5s linear infinite;
    }
  </style>
  </head>
<body class="min-h-screen bg-slate-50">
  <div class="relative isolate">

    <header class="sticky top-0 z-30 border-b border-slate-200/60 bg-white/80 backdrop-blur">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <div class="flex items-center gap-3 justify-between">
          <div class="flex items-center gap-2">
            <div class="leading-tight">
              <div class="text-indigo-700 font-extrabold tracking-tight text-lg">Tenis Karar Destek Sistemi</div>
            </div>
          </div>
          <div class="flex items-center justify-end gap-3 w-auto sm:w-[420px]">
            <button id="refreshBtn" class="text-indigo-700 hover:text-indigo-900 p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" title="Yenile">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4">
                    <path d="M11 2L13 3.99545L12.9408 4.05474M13 18.0001L11 19.9108L11.0297 19.9417M12.9408 4.05474L11 6M12.9408 4.05474C12.6323 4.01859 12.3183 4 12 4C7.58172 4 4 7.58172 4 12C4 14.5264 5.17107 16.7793 7 18.2454M17 5.75463C18.8289 7.22075 20 9.47362 20 12C20 16.4183 16.4183 20 12 20C11.6716 20 11.3477 19.9802 11.0297 19.9417M13 22.0001L11.0297 19.9417" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </button>
        
            <div class="flex items-center gap-1 text-xs sm:text-[11px] bg-slate-100 rounded-full p-1">
              <button id="btnLive" class="px-3 py-1 rounded-full bg-indigo-600 text-white">Canlı</button>
              <button id="btnFinished" class="px-3 py-1 rounded-full text-slate-700 hover:bg-white">Bitti</button>
              <button id="btnUpcoming" class="px-3 py-1 rounded-full text-slate-700 hover:bg-white">Yaklaşan</button>
            </div>
            <div id="lastUpdate" class="hidden md:block text-[11px] text-slate-500"></div>
        </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div id="status" class="mb-4 text-slate-600 text-sm">Veri yükleniyor...</div>



      <div id="loadingOverlay" class="hidden rounded-xl border border-slate-200 bg-white shadow-sm p-8 grid place-items-center min-h-[280px]">
        <div class="flex flex-col items-center gap-4">
          <div class="text-slate-600 text-sm">Maçlar yükleniyor...</div>
          <div class="relative w-48 h-1.5 rounded bg-slate-200 overflow-hidden">
            <div class="absolute h-full w-full bg-gradient-to-r from-indigo-500 to-fuchsia-500 animate-slide"></div>
        </div>
        </div>
      </div>
      <div id="matches" class="w-full"></div>
      <div class="flex justify-center mt-2.5">
        <div class="text-xs text-slate-500">
            <span id="matchCount" class="font-semibold text-slate-700">0</span> maç listeleniyor
        </div>
    </div>

    </main>

    <footer class="mt-8 border-t border-slate-200/60 py-6">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-[11px] text-slate-500 flex items-center justify-between">
        <span>© 2025 Tenis Karar Destek Sistemi</span>
        <span> </span>
      </div>
    </footer>
  </div>

  <div id="modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 relative max-h-[80vh] overflow-y-auto">
      <button onclick="closeModal()" class="absolute top-3 right-3 text-white bg-indigo-600 hover:bg-indigo-700 rounded-full p-2 shadow z-20">✕</button>
      <div id="modalContent" class="p-6">
        <h3 id="matchPlayers" class="text-lg font-semibold mb-2"></h3>
        <p id="modalSubtitle" class="text-gray-600 mb-4 italic"></p>
        <div class="border-b mb-4 sticky top-0 bg-white z-10 pb-2">
          <nav class="flex flex-wrap gap-2" id="modalTabs">
            <button class="tabBtn" data-tab="summary">📋 Özet</button>
            <button class="tabBtn" data-tab="prediction">🧠 Tahmin</button>
            <button class="tabBtn" data-tab="statistics">📊 İstatistikler</button>
            <button class="tabBtn" data-tab="point">🎯 Puan Puan</button>
            <button class="tabBtn" data-tab="momentum">📈 Momentum</button>
            <button class="tabBtn" data-tab="h2h">🤝 H2H</button>
            <button class="tabBtn" data-tab="form">🔥 Form</button>
            <button class="tabBtn" data-tab="votes">🗳️ Oylar</button>
            <button class="tabBtn" data-tab="odds">💰 Oranlar</button>
          </nav>
        </div>
        <div id="tabContent" class="space-y-3 text-gray-700 text-sm leading-relaxed">Yükleniyor...</div>
      </div>
    </div>
  </div>

  <div id="playerModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full mx-4 relative max-h-[80vh] overflow-y-auto">
        <button onclick="closePlayerModal()" class="absolute top-3 right-3 text-white bg-indigo-600 hover:bg-indigo-700 rounded-full p-2 shadow">✕</button>
        <div class="p-6">
          <h2 id="playerName" class="text-2xl font-bold text-indigo-700 mb-2"></h2>
          <p id="playerCountry" class="text-gray-600 mb-4 italic"></p>
          <div class="border-b mb-4 sticky top-0 bg-white z-10 pb-2">
            <nav class="flex gap-2">
              <button class="playerTabBtn" data-tab="profile">👤 Profil</button>
              <button class="playerTabBtn" data-tab="matches">🎾 Son Maçlar</button>
            </nav>
          </div>
          <div id="playerTabContent" class="text-sm text-gray-700 leading-relaxed">Yükleniyor...</div>
        </div>
      </div>
    </div>

<script>
  let modalRefreshInterval = null;
  let currentEventData = null;
  let currentEventDetails = null;
  const playerDataCache = {};
  let currentFilter = "live";
  // Odds cache for current day
  let oddsMap = null; // { [eventId]: { preHome, preAway, liveHome, liveAway } }
  let oddsMapDate = "";
  // Predictions map for today (from server JSON)
  let predMap = null; // { [eventId]: { home_win_prob, away_win_prob, ... } }
  // Prediction prefetch cache (front-end, very short lived)
  const predictionCache = new Map(); // key: eventId, value: {ts, data}
  const PRED_CACHE_TTL_MS = 60000; // 60s

  function getLocalDateISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function toDecimal(choice) {
    if (!choice) return "-";
    if (choice.decimalValue) {
      const dec = parseFloat(choice.decimalValue);
      if (!isNaN(dec)) return dec.toFixed(2);
    }
    const f = choice.fractionalValue;
    if (typeof f === 'string' && f.includes('/')) {
      const [a, b] = f.split('/').map(Number);
      if (b) return (1 + a / b).toFixed(2);
    }
    return typeof f === 'string' ? f : "-";
  }

  function pickMarkets(container) {
    if (!container || typeof container !== 'object') return [];
    if (Array.isArray(container.markets)) return container.markets;
    if (container.odds && Array.isArray(container.odds.markets)) return container.odds.markets;
    if (container.eventOdds && Array.isArray(container.eventOdds.markets)) return container.eventOdds.markets;
    if (Array.isArray(container?.event?.markets)) return container.event.markets;
    if (Array.isArray(container?.data?.markets)) return container.data.markets;
    return [];
  }

  async function ensureOddsForToday() {
    const today = getLocalDateISO();
    if (oddsMap && oddsMapDate === today) return;
    
    oddsMap = {};
    oddsMapDate = today;
    
    try {
      const r = await fetch(`/api/odds/date/${today}`);
      if (!r.ok) return; // silently skip
      const data = await r.json();

      // Gelen veri {"odds": [ ... ]} formatında. Listeyi alıyoruz.
      const list = data?.odds || [];

      list.forEach((market) => {
        // Python kodunda eklediğimiz eventId'yi doğrudan alıyoruz.
        const eventId = market.id;
        if (!eventId) return;

        // Her bir 'market' objesi, aradığımız marketin kendisi.
        // Sadece 'Full time' marketleriyle ilgilendiğimizden emin olalım.
        const marketName = String(market.marketName || '').toLowerCase();
        if (!marketName.includes('full time')) return;

        // Bu yardımcı fonksiyonlar zaten doğru çalışıyor.
        const pickChoice = (m, key) => {
          if (!m || !Array.isArray(m.choices)) return null;
          return m.choices.find(c => c.name === key) || m.choices[key === '1' ? 0 : 1] || null;
        };
        
        const c1 = pickChoice(market, '1');
        const c2 = pickChoice(market, '2');

        let preHome = '-', preAway = '-', liveHome = '-', liveAway = '-';

        if (market.isLive) {
          liveHome = toDecimal(c1);
          liveAway = toDecimal(c2);
        } else {
          preHome = toDecimal(c1);
          preAway = toDecimal(c2);
        }

        const hasAny = [preHome, preAway, liveHome, liveAway].some(v => v && v !== '-');
        if (hasAny) {
          // Aynı eventId için hem maç öncesi hem de canlı oran gelebilir, bu yüzden birleştiriyoruz.
          if (!oddsMap[eventId]) {
            oddsMap[eventId] = {};
          }
          if (preHome !== '-') oddsMap[eventId].preHome = preHome;
          if (preAway !== '-') oddsMap[eventId].preAway = preAway;
          if (liveHome !== '-') oddsMap[eventId].liveHome = liveHome;
          if (liveAway !== '-') oddsMap[eventId].liveAway = liveAway;
        }
      });
      

    } catch (e) {
      console.warn('Odds fetch skipped:', e);
    }
  }

  async function ensurePredictionsForToday() {
    const today = getLocalDateISO();
    if (predMap && predMap.__date === today) return;
    try {
      const r = await fetch(`/api/predictions/today`);
      if (!r.ok) { predMap = { __date: today }; return; }
      const data = await r.json();
      predMap = Object.assign({ __date: today }, data || {});
    } catch (e) {
      predMap = { __date: today };
    }
  }

  function extractOddsFromMarkets(markets) {
    if (!Array.isArray(markets)) return { preHome: '-', preAway: '-', liveHome: '-', liveAway: '-' };
    const isMatchName = (n) => {
      const s = String(n || '').toLowerCase();
      return s.includes('full time') || s.includes('match winner') || s === 'winner' || s.includes('moneyline') || s.includes('kazanan');
    };
    const pickChoice = (market, key) => {
      if (!market || !Array.isArray(market.choices)) return null;
      return market.choices.find(c => c.name === key)
          || market.choices.find(c => String(c.name).toLowerCase() === (key === '1' ? 'home' : 'away'))
          || market.choices[(key === '1') ? 0 : 1] || null;
    };
    const live = markets.find(m => m?.isLive && isMatchName(m?.marketName)) || markets.find(m => m?.isLive);
    const pre  = markets.find(m => !m?.isLive && isMatchName(m?.marketName)) || markets.find(m => !m?.isLive);
    const cL1 = pickChoice(live, '1'); const cL2 = pickChoice(live, '2');
    const cP1 = pickChoice(pre,  '1'); const cP2 = pickChoice(pre,  '2');
    return {
      preHome: toDecimal(cP1), preAway: toDecimal(cP2),
      liveHome: toDecimal(cL1), liveAway: toDecimal(cL2)
    };
  }

  function updateRowOdds(eid, odds) {
    const row = document.querySelector(`tbody tr[data-eid="${eid}"]`);
    if (!row) return;
    const scoreCell = row.querySelector('td:nth-child(3)');
    if (!scoreCell) return;
    const existing = scoreCell.querySelector('[data-odds-center]');
    const hasAny = [odds.preHome, odds.preAway, odds.liveHome, odds.liveAway].some(v => v && v !== '-');
    const html = hasAny ? `<div data-odds-center class="text-[11px] text-slate-600 mt-1 whitespace-nowrap">${odds.preHome && odds.preHome !== '-' ? odds.preHome : ''}${odds.liveHome && odds.liveHome !== '-' ? ` <span class=\"text-emerald-600\">(${odds.liveHome})</span>` : ''} - ${odds.preAway && odds.preAway !== '-' ? odds.preAway : ''}${odds.liveAway && odds.liveAway !== '-' ? ` <span class=\"text-emerald-600\">(${odds.liveAway})</span>` : ''}</div>` : '';
    if (existing) { existing.outerHTML = html; }
    else if (html) { scoreCell.insertAdjacentHTML('beforeend', html); }
  }

  function closeModal() {
    const modal = document.getElementById("modal");
    modal.classList.add("hidden");
    if (modalRefreshInterval) { clearInterval(modalRefreshInterval); modalRefreshInterval = null; }
    currentEventData = null; currentEventDetails = null;
    const matchPlayers = document.getElementById("matchPlayers");
    const subtitle = document.getElementById("modalSubtitle");
    const tabContent = document.getElementById("tabContent");
    if (matchPlayers) matchPlayers.innerHTML = '';
    if (subtitle) subtitle.textContent = '';
    if (tabContent) tabContent.innerHTML = 'Yükleniyor...';
  }

  function closePlayerModal() { document.getElementById("playerModal").classList.add("hidden"); }

  function createTable(headers, rows) {
    return `<table class="min-w-full border text-sm border-gray-300 rounded-lg overflow-hidden"><thead class="bg-indigo-100"><tr>${headers.map(h => `<th class="px-3 py-2 text-left font-semibold">${h}</th>`).join("")}</tr></thead><tbody>${rows.map((r, i) => `<tr class="${i % 2 ? 'bg-gray-50' : 'bg-white'} hover:bg-gray-100 border-t">${r.map(c => `<td class="px-3 py-2">${c}</td>`).join("")}</tr>`).join("")}</tbody></table>`;
  }

  function getTournamentLogo(ev) {
    return ev?.tournament?.category?.id ? `https://img.sofascore.com/api/v1/category/${ev.tournament.category.id}/image` : "https://cdn-icons-png.flaticon.com/512/861/861512.png";
  }

async function refreshModalData() {
    if (!currentEventData || document.getElementById("modal").classList.contains("hidden")) return;
    try {
      const liveMatchesRes = await fetch(`/api/live-matches`);
      if (liveMatchesRes.ok) {
          const liveMatchesData = await liveMatchesRes.json();
          const updatedEventData = liveMatchesData.events.find(e => e.id === currentEventData.id);
          if (updatedEventData) { currentEventData = updatedEventData; }
      }
      const detailsRes = await fetch(`/api/match-details/${currentEventData.id}`);
      if (!detailsRes.ok) throw new Error(`API Detay Hatası: ${detailsRes.status}`);
      const newDetails = await detailsRes.json();
      currentEventDetails = newDetails;
      const activeTabBtn = document.querySelector(".tabBtn.text-indigo-600.font-semibold");
      if (activeTabBtn) {
        const activeTab = activeTabBtn.dataset.tab;
        if (activeTab !== 'prediction') { loadTabContent(activeTab, currentEventData, currentEventDetails); }
      }
    } catch (error) { console.error("Modal yenileme hatası:", error); }
  }

  async function openModal(eventData) {
    const modal = document.getElementById("modal");
    modal.classList.remove("hidden"); modal.classList.add("flex");
    const tabContent = document.getElementById("tabContent");
    const subtitle = document.getElementById("modalSubtitle");
    const matchPlayers = document.getElementById("matchPlayers");
    matchPlayers.innerHTML = `<span class="text-blue-700 cursor-pointer hover:underline" onclick="openPlayerModal(${eventData.homeTeam.id}, '${eventData.homeTeam.name.replace(/'/g, "\\'")}')">${eventData.homeTeam.name}</span> vs <span class="text-orange-600 cursor-pointer hover:underline" onclick="openPlayerModal(${eventData.awayTeam.id}, '${eventData.awayTeam.name.replace(/'/g, "\\'")}')">${eventData.awayTeam.name}</span>`;
    subtitle.textContent = eventData.tournament?.name || "";
    tabContent.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-gray-600"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-indigo-600 mb-3"></div><p>Maç detayları yükleniyor...</p></div>`;
    try {
        // details ve prediction'ı paralel başlat (prediction tabına geçişi hızlandırmak için)
        const detailsPromise = fetch(`/api/match-details/${eventData.id}`);
        // front cache: varsa ve taze ise kullanacağız; yoksa arkadan başlat
        const predCached = predictionCache.get(eventData.id);
        if (!predCached || (Date.now() - predCached.ts) > PRED_CACHE_TTL_MS) {
          fetch(`/api/match-prediction/${eventData.id}`)
            .then(r => r.ok ? r.json() : null)
            .then(d => { if (d) predictionCache.set(eventData.id, { ts: Date.now(), data: d }); })
            .catch(()=>{});
        }

        const res = await detailsPromise;
        if (!res.ok) throw new Error("Detaylar alınamadı");
        const details = await res.json();
        currentEventData = eventData; currentEventDetails = details;
        document.querySelectorAll(".tabBtn").forEach(btn => {
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
          newBtn.addEventListener("click", () => {
            document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("text-indigo-600", "font-semibold", "border-indigo-600", "bg-indigo-50"));
            newBtn.classList.add("text-indigo-600", "font-semibold", "border-indigo-600", "bg-indigo-50");
            loadTabContent(newBtn.dataset.tab, currentEventData, currentEventDetails);
          });
        });
        const first = document.querySelector(".tabBtn[data-tab='summary']");
        first.classList.add("text-indigo-600", "font-semibold", "border-indigo-600", "bg-indigo-50");
        loadTabContent("summary", currentEventData, currentEventDetails);
        if (modalRefreshInterval) clearInterval(modalRefreshInterval);
        modalRefreshInterval = setInterval(refreshModalData, 10000);
    } catch (error) {
        tabContent.innerHTML = "<p class='text-red-600'>Maç detayları yüklenirken bir hata oluştu.</p>";
        console.error("Maç detayı yükleme hatası:", error);
    }
  }

  async function loadTabContent(tab, eventData, details) {
    const content = document.getElementById("tabContent");
    content.innerHTML = "";
    if (tab === "prediction") {
        const loadingSteps = [
            "Tahmin motoru başlatılıyor...",
            "Maçın temel bilgileri ve oyuncu ID'leri alınıyor...",
            `[${eventData.homeTeam.name}] için veri toplanıyor (Maç geçmişi, yıllık istatistikler vb.)...`,
            `[${eventData.awayTeam.name}] için veri toplanıyor (Maç geçmişi, yıllık istatistikler vb.)...`,
            "Tüm veriler toplandı, TGS metrikleri yüzeye göre hesaplanıyor..."
        ];
        let stepIndex = 0;
        content.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-gray-600">
                               <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-indigo-600 mb-3"></div>
                               <p id="loading-status">${loadingSteps[stepIndex]}</p>
                             </div>`;
        const statusElement = document.getElementById("loading-status");
        const interval = setInterval(() => { stepIndex++; if (stepIndex < loadingSteps.length) { statusElement.textContent = loadingSteps[stepIndex]; } else { clearInterval(interval); } }, 2000);
        try {
            // Önce front cache'e bak
            let data = null;
            const cached = predictionCache.get(eventData.id);
            if (cached && (Date.now() - cached.ts) <= PRED_CACHE_TTL_MS) {
              data = cached.data;
            } else {
              const res = await fetch(`/api/match-prediction/${eventData.id}`);
              if (!res.ok) throw new Error(`Sunucu hatası: ${res.status}`);
              data = await res.json();
              if (data && !data.error) predictionCache.set(eventData.id, { ts: Date.now(), data });
            }
            clearInterval(interval);
            if (data.error) { content.innerHTML = `<p class="text-red-500">${data.error}</p>`; return; }
            // Pre-match etiketi (T-xx)
            let preTag = "Pre-match";
            const ts = Number(eventData.startTimestamp || 0) * 1000;
            if (ts > 0) {
              const mins = Math.max(0, Math.round((ts - Date.now()) / 60000));
              preTag = mins > 0 ? `Pre-match (T-${mins})` : "Pre-match";
            }
            const homeProb = (data.home_win_prob * 100).toFixed(1);
            const awayProb = (data.away_win_prob * 100).toFixed(1);
            let tableRows = '';
            for (const key of Object.keys(data.weights).sort()) {
                const weight = (data.weights[key] * 100).toFixed(1);
                const homeScore = data.scores.home[key] !== undefined ? data.scores.home[key].toFixed(3) : '-';
                const awayScore = data.scores.away[key] !== undefined ? data.scores.away[key].toFixed(3) : '-';
                const metricName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                tableRows += `<tr class="border-t hover:bg-gray-50"><td class="py-2 px-3 font-semibold text-gray-600">${metricName} <span class="text-xs italic text-gray-400">(${weight}%)</span></td><td class="py-2 px-3 text-center">${homeScore}</td><td class="py-2 px-3 text-center">${awayScore}</td></tr>`;
            }
            content.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-blue-700">${data.home_player_name}</span>
                            <span class="font-bold text-orange-600">${data.away_player_name}</span>
                        </div>
                        <div class="mb-2 text-xs inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-200">${preTag}</div>
                        <div class="flex w-full h-8 bg-gray-200 rounded-full overflow-hidden">
                            <div class="flex items-center justify-center h-full bg-blue-600 text-white font-bold" style="width: ${homeProb}%">${homeProb}%</div>
                            <div class="flex items-center justify-center h-full bg-orange-500 text-white font-bold" style="width: ${awayProb}%">${awayProb}%</div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-indigo-700 mb-2">Metrik Detayları</h4>
                        <table class="min-w-full border text-sm border-gray-300 rounded-lg">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th class="py-2 px-3 text-left font-semibold">Metrik (Ağırlık)</th>
                                    <th class="py-2 px-3 text-center font-semibold">Ev Sahibi Skor</th>
                                    <th class="py-2 px-3 text-center font-semibold">Deplasman Skor</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>`;
        } catch(err) { clearInterval(interval); content.innerHTML = `<p class="text-red-500">Tahmin hesaplanırken bir hata oluştu. Sunucu loglarını kontrol edin.</p>`; console.error("Tahmin API hatası:", err); }
        return;
    }
    if (tab === "summary") {
      const statusType = eventData.status?.type;
      const statusDescription = eventData.status?.description || "";
      const winnerCode = eventData.winnerCode;

      const isSpecialFinish = statusType === 'finished' && winnerCode && (statusDescription.includes('Walkover') || statusDescription.includes('Hükmen') || statusDescription.includes('Retired'));

      if (isSpecialFinish) {
          // 1. İngilizce terimleri Türkçe'ye çevir
          const displayText = statusDescription.replace('Walkover', 'Hükmen').replace('Retired', 'Çekildi');

          // 2. Kazananı Ev Sahibi/Deplasman renkleriyle, kaybedeni soluk bir renkle göster
          let homeResult, awayResult;
          if (winnerCode === 1) { // Ev Sahibi (Mavi) kazandı
              homeResult = '<span class="text-3xl font-bold text-blue-700">W</span>';
              awayResult = '<span class="text-3xl font-bold text-slate-400">L</span>';
          } else { // Deplasman (Turuncu) kazandı
              homeResult = '<span class="text-3xl font-bold text-slate-400">L</span>';
              awayResult = '<span class="text-3xl font-bold text-orange-600">W</span>';
          }
          
          // 3. Yeni stil ve çeviri ile HTML'i oluştur
          content.innerHTML = `
              <div class="text-center space-y-2 py-4">
                  <div class="flex items-center justify-center gap-4">
                      ${homeResult}
                      <span class="text-3xl font-bold text-slate-400">-</span>
                      ${awayResult}
                  </div>
                  <p class="italic text-slate-500 font-semibold">${displayText}</p>
              </div>`;

      } else {
          // Normal maçlar için olan kod aynı kalıyor
          const homeScore = eventData.homeScore;
          const awayScore = eventData.awayScore;
          const sets = [];
          if (homeScore && awayScore) {
              for (let i = 1; i <= 5; i++) {
                  const periodKey = `period${i}`;
                  if (homeScore.hasOwnProperty(periodKey) && awayScore.hasOwnProperty(periodKey)) { sets.push(`${homeScore[periodKey]} - ${awayScore[periodKey]}`); } else { break; }
              }
          }
          const currentScore = (homeScore && homeScore.current !== undefined) ? `${homeScore.current} - ${awayScore.current}` : "0 - 0";
          const statusText = eventData.status?.description || "Maç devam ediyor";
          const setsText = sets.length ? "Setler: " + sets.join(", ") : "";
          content.innerHTML = `<div class="text-center"><h3 class="text-3xl font-bold text-indigo-700">${currentScore}</h3><p class="italic text-gray-600">${statusText}</p><p class="text-sm text-gray-700 mt-2">${setsText}</p></div>`;
      }
      return;
    }
    
    if (tab === "statistics") {
      const stats = details.statistics?.statistics || [];
      if (!stats.length) { content.innerHTML = "<p>Veri yok.</p>"; return; }
      content.innerHTML = `<div class="flex gap-2 mb-3"><button id="btnGenel" class="bg-indigo-600 text-white px-3 py-1 rounded">Genel</button><button id="btnSet" class="bg-gray-200 px-3 py-1 rounded">Set Bazlı</button></div><div id="statsContent" class="space-y-3"></div>`;
      const statsDiv = document.getElementById("statsContent");
      const showGeneral = () => { statsDiv.innerHTML = ""; (stats[0]?.groups || []).forEach(g => { statsDiv.innerHTML += `<h4 class="font-semibold text-indigo-600 mt-2">${g.groupName}</h4>` + createTable(["İstatistik","Ev Sahibi","Deplasman"], (g.statisticsItems||[]).map(i => [i.name, i.home ?? "-", i.away ?? "-"])); }); };
      const showSet = () => { statsDiv.innerHTML = ""; stats.forEach((set,i) => { const title = set.period || ("Set " + (i+1)); const htmlGroups = (set.groups||[]).map(g => createTable(["İstatistik","Ev Sahibi","Deplasman"], (g.statisticsItems||[]).map(i => [i.name, i.home ?? "-", i.away ?? "-"])) ).join(""); statsDiv.innerHTML += `<h4 class="font-semibold text-indigo-600 mt-2">${title}</h4>${htmlGroups}`; }); };
      showGeneral();
      document.getElementById("btnGenel").onclick = ()=>{ showGeneral(); document.getElementById("btnGenel").className="bg-indigo-600 text-white px-3 py-1 rounded"; document.getElementById("btnSet").className="bg-gray-200 px-3 py-1 rounded";};
      document.getElementById("btnSet").onclick   = ()=>{ showSet(); document.getElementById("btnSet").className="bg-indigo-600 text-white px-3 py-1 rounded"; document.getElementById("btnGenel").className="bg-gray-200 px-3 py-1 rounded";};
      return;
    }
    if (tab === "point") {
      const data = details.pointByPoint;
      const sets = Array.isArray(data?.pointByPoint) ? data.pointByPoint : Array.isArray(data?.sets) ? data.sets : [];
      if (!sets.length) { content.innerHTML = "<p>🎯 Veri bulunamadı.</p>"; return; }
      sets.forEach((s, idx) => { const games = s.games || []; content.innerHTML += `<h4 class="font-semibold text-indigo-600 mt-2">Set ${s.set || idx+1}</h4>` + createTable(["Oyun","Ev Sahibi","Deplasman"], games.map(g => [g.game ?? "-", `<span class='text-blue-700 font-medium'>${g.score?.homeScore ?? "-"}</span>`, `<span class='text-orange-600 font-medium'>${g.score?.awayScore ?? "-"}</span>`])); });
      return;
    }
    if (tab === "momentum") {
      const m = details.tennisPower?.tennisPowerRankings;
      if (!m?.length) { content.innerHTML = "<p>Momentum verisi bulunamadı.</p>"; return; }
      const rows = m.map((r,i)=>[i+1, r.value > 0 ? (eventData.homeTeam?.shortName || eventData.homeTeam?.name || "Home") : (eventData.awayTeam?.shortName || eventData.awayTeam?.name || "Away"), r.value]);
      content.innerHTML = createTable(["Sıra","Oyuncu","Momentum"], rows);
      return;
    }
    if (tab === "h2h") {
      const h = details.h2h?.teamDuel || {};
      content.innerHTML = createTable(["İstatistik","Ev Sahibi","Deplasman"], [["Kazanılan Maç", h.homeWins ?? "-", h.awayWins ?? "-"], ["Beraberlik", h.draws ?? "-", "-"]]);
      return;
    }
    if (tab === "form") {
      let root = details?.teamStreaks; if (root && root.teamStreaks) root = root.teamStreaks; if (!root || typeof root !== "object") { content.innerHTML = "<p>🔥 Form verisi bulunamadı.</p>"; return; }
      const all = [...(Array.isArray(root.general) ? root.general : []), ...(Array.isArray(root.head2head) ? root.head2head : [])]; if (!all.length) { content.innerHTML = "<p>🔥 Form verisi bulunamadı.</p>"; return; }
      const homeName = eventData.homeTeam?.name || "Home"; const awayName = eventData.awayTeam?.name || "Away";
      const rows = all.map(item => { let who = "-"; if (typeof item.team === "string") { const t = item.team.toLowerCase(); if (t === "home") who = homeName; else if (t === "away") who = awayName; else if (t === "both") who = `${homeName} & ${awayName}`; else who = item.team; } else if (item.team?.name) { who = item.team.name; } return [who, item.name || "-", item.value || "-"]; });
      content.innerHTML = createTable(["Oyuncu","Seri","Değer"], rows);
      return;
    }
    if (tab === "votes") {
      const v = details.votes?.vote || {}; const vote1 = v.vote1 ?? 0, vote2 = v.vote2 ?? 0; const total = (vote1 + vote2) || 1; const p1 = ((vote1 / total) * 100).toFixed(1); const p2 = ((vote2 / total) * 100).toFixed(1);
      const home = eventData.homeTeam?.name || "Home"; const away = eventData.awayTeam?.name || "Away";
      content.innerHTML = createTable(["Oyuncu","Oy Sayısı","Yüzde"], [[`<span class='text-blue-700 font-medium'>${home}</span>`, vote1, `${p1}%`], [`<span class='text-orange-600 font-medium'>${away}</span>`, vote2, `${p2}%`]]);
      return;
    }
    if (tab === "odds") {
      const all = details.oddsAll?.markets || [];
      const getOdds = (market, choiceName) => {
          const choice = market?.choices?.find(c => c.name === choiceName);
          if (!choice) return "-";
          if (choice.decimalValue) { const decVal = parseFloat(choice.decimalValue); if (!isNaN(decVal)) return decVal.toFixed(2); }
          const f = choice.fractionalValue; if (!f || typeof f !== "string" || !f.includes("/")) return f || "-";
          const [a, b] = f.split("/").map(Number); return b ? (1 + a / b).toFixed(2) : (f || "-");
      };
      const liveMarket = all.find(m => m.isLive && m.marketName === "Full time");
      const preMarket = all.find(m => !m.isLive && m.marketName === "Full time");
      let html = `<div class="space-y-6">`;
      const liveHomeOdds = getOdds(liveMarket, "1"); const liveAwayOdds = getOdds(liveMarket, "2");
      if (liveHomeOdds !== "-") { html += `<h4 class="text-xl font-bold text-green-700">🟢 Canlı Bahis Oranları</h4><div class="grid grid-cols-2 gap-3"><div class="bg-green-100 p-4 text-center rounded-lg"><div class="font-semibold">${eventData.homeTeam?.name}</div><div class="text-2xl font-extrabold">${liveHomeOdds}</div></div><div class="bg-green-100 p-4 text-center rounded-lg"><div class="font-semibold">${eventData.awayTeam?.name}</div><div class="text-2xl font-extrabold">${liveAwayOdds}</div></div></div>`; }
      const preHomeOdds = getOdds(preMarket, "1"); const preAwayOdds = getOdds(preMarket, "2");
      if (preHomeOdds !== "-") { html += `<h4 class="text-xl font-bold text-indigo-700 mt-4">🕓 Maç Önü Oranları</h4><div class="grid grid-cols-2 gap-3"><div class="bg-indigo-50 p-4 text-center rounded-lg"><div class="font-semibold">${eventData.homeTeam?.name}</div><div class="text-2xl font-extrabold">${preHomeOdds}</div></div><div class="bg-indigo-50 p-4 text-center rounded-lg"><div class="font-semibold">${eventData.awayTeam?.name}</div><div class="text-2xl font-extrabold">${preAwayOdds}</div></div></div>`; }
      if (liveHomeOdds === "-" && preHomeOdds === "-") { html += "<p>💰 Bu etkinlik için oran bulunamadı.</p>"; }
      html += `</div>`; content.innerHTML = html; return;
    }
  }

  async function openPlayerModal(teamId, playerName = "Oyuncu") {
    const modal = document.getElementById("playerModal");
    const content = document.getElementById("playerTabContent");
    const nameEl = document.getElementById("playerName");
    modal.classList.remove("hidden"); modal.classList.add("flex"); nameEl.textContent = playerName;
    document.querySelectorAll(".playerTabBtn").forEach(btn => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      newBtn.addEventListener("click", () => {
        document.querySelectorAll(".playerTabBtn").forEach(b => b.classList.remove("text-indigo-600", "font-semibold"));
        newBtn.classList.add("text-indigo-600", "font-semibold");
        loadPlayerTab(newBtn.dataset.tab, teamId);
      });
    });
    const firstTab = document.querySelector(".playerTabBtn[data-tab='profile']");
    firstTab.classList.add("text-indigo-600", "font-semibold");
    if (playerDataCache[teamId]) { loadPlayerTab("profile", teamId); return; }
    content.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-gray-600"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-indigo-600 mb-3"></div><p>Oyuncu bilgileri yükleniyor...</p></div>`;
    try {
      const [profileRes, matchesRes, rankRes] = await Promise.all([
        fetch(`/api/player/${teamId}`), fetch(`/api/player/${teamId}/matches`), fetch(`/api/player/${teamId}/rankings`)
      ]);
      const [profileData, matchesData, rankData] = await Promise.all([profileRes.json(), matchesRes.json(), rankRes.json()]);
      playerDataCache[teamId] = { profile: profileData, matches: matchesData, rankings: rankData?.rankings || [] };
      loadPlayerTab("profile", teamId);
    } catch (error) { console.error("Oyuncu verisi alınırken hata:", error); content.innerHTML = "<p>⚠️ Oyuncu bilgileri yüklenirken bir hata oluştu.</p>"; }
  }

  function loadPlayerTab(tab, teamId) {
    const content = document.getElementById("playerTabContent");
    const cachedData = playerDataCache[teamId];
    if (!cachedData) { content.innerHTML = "<p>Oyuncu verisi bulunamadı.</p>"; return; }
    function belongsToPlayer(teamObj, playerObj, playerId) {
        if (!teamObj || !playerObj) return false; if (teamObj.id && playerId && teamObj.id === playerId) return true;
        const teamName = (teamObj.name || "").toLowerCase(); const playerName = (playerObj.name || "").toLowerCase(); if (!teamName || !playerName) return false;
        const nameParts = playerName.replace(/,/g, '').split(' '); return nameParts.some(part => part.length > 2 && teamName.includes(part));
    }
    if (tab === "profile") {
        const data = cachedData.profile; const rankings = cachedData.rankings; const info = data.team?.playerTeamInfo || {}; const country = data.team?.country?.name || "Bilinmiyor";
        document.getElementById("playerCountry").textContent = country;
        const official = rankings.find(r => r.type === 5 || r.rankingClass === "team");
        const live = rankings.find(r => r.type === 7 || r.rankingClass === "livetennis");
        const utr = rankings.find(r => r.type === 34 || r.rankingClass === "utr");
        const officialRanking = official?.ranking ?? "-"; const officialPoints = official?.points ?? "-";
        const liveRanking = live?.ranking ?? "-"; const livePoints = live?.points ?? "-";
        const utrRanking = utr?.ranking ?? "-"; const utrPoints = utr?.points?.toFixed ? utr.points.toFixed(2) : (utr?.points ?? "-");
        content.innerHTML = `<div class="space-y-6"><div class="bg-gradient-to-r from-purple-100 to-pink-50 border-l-4 border-purple-400 rounded-xl p-4 shadow-sm"><h4 class="text-lg font-bold text-purple-700">🎾 Oyuncu Bilgileri</h4><div class="grid grid-cols-2 gap-2 mt-2 text-sm text-gray-700"><p><b>Doğum Yeri:</b> ${info.birthplace || "-"}</p><p><b>Yaşadığı Yer:</b> ${info.residence || "-"}</p><p><b>Boy:</b> ${info.height ? info.height + " m" : "-"}</p><p><b>Kilo:</b> ${info.weight ? info.weight + " kg" : "-"}</p><p><b>El Tercihi:</b> ${info.plays || "-"}</p><p><b>Profesyonel Olma:</b> ${info.turnedPro || "-"}</p><p><b>Kariyer Kazancı:</b> €${info.prizeTotal?.toLocaleString?.() || "-"}</p></div></div><div class="bg-gradient-to-r from-yellow-100 to-yellow-50 border-l-4 border-yellow-400 rounded-xl p-4 shadow-sm"><h4 class="text-lg font-bold text-yellow-700">🏆 Resmi Sıralama</h4><div class="grid grid-cols-2 gap-2 mt-2 text-sm text-gray-700"><p><b>Sıralama:</b> ${officialRanking}</p><p><b>Puan:</b> ${officialPoints}</p></div></div><div class="bg-gradient-to-r from-green-100 to-green-50 border-l-4 border-green-400 rounded-xl p-4 shadow-sm"><h4 class="text-lg font-bold text-green-700">📈 Canlı Sıralama</h4><div class="grid grid-cols-2 gap-2 mt-2 text-sm text-gray-700"><p><b>Sıralama:</b> ${liveRanking}</p><p><b>Puan:</b> ${livePoints}</p></div></div><div class="bg-gradient-to-r from-blue-100 to-blue-50 border-l-4 border-blue-400 rounded-xl p-4 shadow-sm"><h4 class="text-lg font-bold text-blue-700">🌍 UTR Sıralaması</h4><div class="grid grid-cols-2 gap-2 mt-2 text-sm text-gray-700"><p><b>Sıralama:</b> ${utrRanking}</p><p><b>Puan:</b> ${utrPoints}</p></div></div></div>`;
    }
    if (tab === "matches") {
        const data = cachedData.matches; const events = (data.events || []).sort((a, b) => b.startTimestamp - a.startTimestamp).slice(0, 10);
        if (!events.length) { content.innerHTML = "<p>🎾 Son 10 maça ait veri bulunamadı.</p>"; return; }
        const playerInfo = cachedData.profile?.team || {}; const playerTeam = Object.keys(playerInfo).length ? playerInfo : (data.team || {});
        const cards = events.map(ev => {
            const playerIsHome = belongsToPlayer(ev.homeTeam, playerTeam, teamId);
            const playerIsAway = belongsToPlayer(ev.awayTeam, playerTeam, teamId);
            const isFinished = ev.status?.type === "finished";
            const hs = Number(ev.homeScore?.current ?? 0); const as = Number(ev.awayScore?.current ?? 0);
            const kazandi = (ev.winnerCode === 1 && playerIsHome) || (ev.winnerCode === 2 && playerIsAway);
            const tarih = ev.startTimestamp ? new Date(ev.startTimestamp * 1000).toLocaleDateString("tr-TR", { day: "2-digit", month: "short", year: "numeric" }) : "-";
            const sonucHtml = isFinished ? (kazandi ? `<span class="text-green-600 font-semibold">Kazandı</span>` : `<span class="text-red-600 font-semibold">Kaybetti</span>`) : `<span class="text-gray-500 italic">${ev.status?.description || ""}</span>`;
            return `<div class="bg-white border rounded-xl p-4"><div class="flex justify-between items-center mb-2"><h4 class="text-indigo-700 font-semibold text-sm">${ev.tournament?.name || "-"}</h4><span class="text-gray-500 text-xs">${tarih}</span></div><div class="flex items-center justify-between text-sm"><span class="font-semibold ${playerIsHome ? 'text-blue-700' : ''}">${ev.homeTeam?.name || "-"}</span><span class="font-bold text-lg">${hs} - ${as}</span><span class="font-semibold ${playerIsAway ? 'text-orange-600' : ''}">${ev.awayTeam?.name || "-"}</span></div><div class="text-right mt-2 text-xs">${sonucHtml}</div></div>`;
        }).join("");
        content.innerHTML = `<h4 class="text-lg font-bold mb-3">Son 10 Maç</h4><div class="grid sm:grid-cols-2 gap-3">${cards}</div>`;
    }
  }

  async function loadMatches() {
    const cnt = document.getElementById("matches"), status = document.getElementById("status"), last = document.getElementById("lastUpdate");
    const overlay = document.getElementById("loadingOverlay"); const counterEl = document.getElementById("matchCount");
    try {
        const endpoint = `/api/matches?filter=${currentFilter}`;
        status.textContent = "";
        overlay.classList.remove("hidden");
        cnt.innerHTML = "";
        console.time('matches+odds');
        const [r] = await Promise.all([
            fetch(endpoint),
            ensureOddsForToday(),
            ensurePredictionsForToday()
        ]);
        console.timeEnd('matches+odds');
        const d = await r.json(); const events = Array.isArray(d.events) ? d.events : [];
        console.log('render: events=', events.length, 'filter=', currentFilter);
        counterEl.textContent = events.length.toString();
        if (!events.length) { status.textContent = currentFilter === "live" ? "Şu an canlı maç yok." : "Listelenecek maç bulunamadı."; cnt.innerHTML = ""; overlay.classList.add("hidden"); last.textContent = ""; return; }
        last.textContent = "Son güncelleme: " + new Date().toLocaleTimeString("tr-TR"); cnt.innerHTML = ""; overlay.classList.add("hidden");
        const nowTs = Math.floor(Date.now() / 1000);
        if (currentFilter === 'upcoming') { events.sort((a,b) => (a.startTimestamp||nowTs) - (b.startTimestamp||nowTs)); }
        else if (currentFilter === 'finished') { events.sort((a,b) => (b.startTimestamp||0) - (a.startTimestamp||0)); }
        else { events.sort((a,b) => { const aLive = (a.status?.type === "inprogress"); const bLive = (b.status?.type === "inprogress"); if (aLive !== bLive) return aLive ? -1 : 1; return Math.abs((a.startTimestamp||nowTs) - nowTs) - Math.abs((b.startTimestamp||nowTs) - nowTs); }); }
        
        const pillColor = (e) => {
            const t = e?.status?.type; if (t === 'inprogress') return 'bg-emerald-100 text-emerald-800'; if (t === 'finished') return 'bg-slate-100 text-slate-800'; return 'bg-indigo-100 text-indigo-800';
        };

        let rowsHtml = '';
        let mobileHtml = '';

        events.forEach((e) => {
            const isLive = e.status?.type === "inprogress"; 
            const isFinished = e.status?.type === "finished";

            const eventDate = e.startTimestamp ? new Date(e.startTimestamp * 1000) : null;
            const formattedDateTime = eventDate ? eventDate.toLocaleString("tr-TR", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" }) : "-";
            const formattedTime = eventDate ? eventDate.toLocaleTimeString("tr-TR", {hour:"2-digit", minute:"2-digit"}) : "-";

            let scoreOrStatusHtml;
            const statusType = e.status?.type;
            const statusDescription = e.status?.description || "";
            const winnerCode = e.winnerCode;

            const isSpecialFinish = isFinished && winnerCode && (statusDescription.includes('Walkover') || statusDescription.includes('Hükmen') || statusDescription.includes('Retired'));
            const isPostponedOrCancelled = ['postponed', 'cancelled', 'interrupted'].includes(statusType);

            if (isSpecialFinish) {
                // MODAL İLE AYNI MANTIK BURAYA UYGULANDI
                const displayText = statusDescription.replace('Walkover', 'Hükmen').replace('Retired', 'Çekildi');
                let homeResult, awayResult;

                if (winnerCode === 1) { // Ev sahibi (Mavi) kazandı
                    homeResult = '<span class="font-bold text-blue-700">W</span>';
                    awayResult = '<span class="font-bold text-slate-400">L</span>';
                } else { // Deplasman (Turuncu) kazandı
                    homeResult = '<span class="font-bold text-slate-400">L</span>';
                    awayResult = '<span class="font-bold text-orange-600">W</span>';
                }
                
                scoreOrStatusHtml = `
                    <div class="text-center">
                        <div class="flex items-center justify-center gap-2 font-bold text-lg">
                            ${homeResult} <span class="text-slate-400">-</span> ${awayResult}
                        </div>
                        <div class="text-[11px] text-slate-500 font-semibold mt-0.5">${displayText}</div>
                    </div>`;
            } else if (isPostponedOrCancelled) {
                scoreOrStatusHtml = `<div class="font-semibold text-amber-600 text-sm">${statusDescription}</div>`;
            } else {
                const scoreText = (isLive || isFinished)
                    ? `${e.homeScore?.current ?? 0} - ${e.awayScore?.current ?? 0}`
                    : formattedTime;
                scoreOrStatusHtml = `<div class="inline-flex items-center justify-center min-w-[70px] px-2.5 py-1 rounded-md ${pillColor(e)} font-extrabold text-base sm:text-lg tracking-wide whitespace-nowrap">${scoreText}</div>`;
            }

            let setsSmall = ""; 
            if ((isFinished || isLive) && !isSpecialFinish && !isPostponedOrCancelled) { 
                const hs = e.homeScore || {}; const as = e.awayScore || {}; const sets = []; 
                for (let i = 1; i <= 5; i++) { const k = `period${i}`; if (hs && as && hs.hasOwnProperty(k) && as.hasOwnProperty(k) && hs[k] != null && as[k] != null) { sets.push(`${hs[k]}-${as[k]}`); } else { break; } } 
                if (sets.length) { setsSmall = `<div class="text-[11px] text-slate-500 mt-1">Setler: ${sets.join(", ")}</div>`; } 
            }

            const homeName = e.homeTeam?.name || '-'; 
            const awayName = e.awayTeam?.name || '-';
            // Precomputed prediction badges (home/away)
            let homePredBadge = '', awayPredBadge = '';
            if (predMap) {
                const p = predMap[String(e.id)];
                if (p && typeof p.home_win_prob === 'number' && typeof p.away_win_prob === 'number') {
                    const ph = Math.round(p.home_win_prob * 100);
                    const pa = Math.round(p.away_win_prob * 100);
                    homePredBadge = `<span class="ml-1 align-middle text-[10px] px-1.5 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-200">${ph}%</span>`;
                    awayPredBadge = `<span class="mr-1 align-middle text-[10px] px-1.5 py-0.5 rounded-full bg-orange-50 text-orange-700 border border-orange-200">${pa}%</span>`;
                }
            }
            const statusBadge = isLive ? '<span class="text-[10px] bg-emerald-500 text-white px-2 py-0.5 rounded-full mr-2">CANLI</span>' : (isFinished ? '<span class="text-[10px] bg-red-500 text-white px-2 py-0.5 rounded-full mr-2">BİTTİ</span>' : '');
            
            const om = oddsMap ? oddsMap[e.id] : null;
            const favIcon = `<span title="Favori">⭐</span>`;
            let homeFavIcon = '', awayFavIcon = '';
            const homeOddsVal = parseFloat(om?.liveHome || om?.preHome);
            const awayOddsVal = parseFloat(om?.liveAway || om?.preAway);
            if (!isNaN(homeOddsVal) && !isNaN(awayOddsVal)) { if (homeOddsVal < awayOddsVal) homeFavIcon = favIcon; else if (awayOddsVal < homeOddsVal) awayFavIcon = favIcon; }
            const formatOdds = (o) => o && o !== '-' ? `<span class="font-normal text-slate-500 text-xs">(${o})</span>` : '';
            const homeOddsDisplay = formatOdds(om?.liveHome || om?.preHome);
            const awayOddsDisplay = formatOdds(om?.liveAway || om?.preAway);

            // Build TGS cell (desktop)
            let tgsCell = '<div class="text-[11px] text-slate-400 italic">-</div>';
            if (predMap) {
                const p = predMap[String(e.id)];
                if (p && typeof p.home_win_prob === 'number' && typeof p.away_win_prob === 'number') {
                    const ph = Math.round(p.home_win_prob * 100);
                    const pa = Math.round(p.away_win_prob * 100);
                    tgsCell = `
                      <div class="flex items-center justify-center">
                        <div class="w-28 h-5 rounded-full bg-slate-200 overflow-hidden flex">
                          <div class="h-full bg-blue-600 text-white text-[10px] flex items-center justify-center" style="width:${ph}%">${ph}%</div>
                          <div class="h-full bg-orange-500 text-white text-[10px] flex items-center justify-center" style="width:${pa}%">${pa}%</div>
                        </div>
                      </div>`;
                }
            }

            rowsHtml += `
              <tr class="even:bg-slate-50/60 hover:bg-slate-50 cursor-pointer group" data-eid="${e.id}" tabindex="0">
                <td class="px-3 sm:px-4 py-3 align-middle text-sm text-slate-600 whitespace-nowrap">${formattedDateTime}</td>
                <td class="px-3 sm:px-4 py-3 align-middle">
                  <div class="flex items-center gap-3 min-w-0">
                    <img src="${getTournamentLogo(e)}" class="w-7 h-7 rounded-full border bg-white object-cover">
                    <div class="text-[12px] sm:text-sm text-slate-900 truncate">${e.tournament?.name || '?'}</div>
                  </div>
                </td>
                <td class="px-3 sm:px-4 py-3 align-middle text-center">
                  ${tgsCell}
                </td>
                <td class="px-3 sm:px-4 py-3 align-middle text-right max-w-[240px]">
                    <div class="truncate font-medium text-blue-700" title="${homeName}">${homeFavIcon} ${homeName} ${homeOddsDisplay}</div>
                </td>
                <td class="px-3 sm:px-4 py-3 align-middle text-center w-[120px]">
                  ${scoreOrStatusHtml}
                  ${setsSmall}
                </td>
                <td class="px-3 sm:px-4 py-3 align-middle text-left max-w-[240px]">
                    <div class="truncate font-medium text-orange-600" title="${awayName}">${awayOddsDisplay} ${awayName} ${awayFavIcon}</div>
                </td>
              </tr>`;

            mobileHtml += `
              <div class="p-3 border-b last:border-b-0 border-slate-200 cursor-pointer" data-eid="${e.id}">
                <div class="flex items-center justify-between gap-3 mb-2">
                    <div class="flex items-center gap-2 min-w-0">
                        <img src="${getTournamentLogo(e)}" class="w-6 h-6 rounded-full border bg-white object-cover">
                        <div class="min-w-0">
                            <div class="text-xs text-slate-800 truncate">${e.tournament?.name || '?'}</div>
                            <div class="text-[11px] text-slate-500">${formattedDateTime}</div>
                        </div>
                    </div>
                    ${statusBadge}
                </div>
                <div class="flex items-center justify-between gap-2">
                  <div class="w-[40%] truncate text-blue-700 text-sm font-medium text-right" title="${homeName}">
                    ${homeFavIcon} ${homeName} ${homePredBadge} ${homeOddsDisplay}
                  </div>
                  <div class="flex-shrink-0 text-center">
                    ${scoreOrStatusHtml}
                  </div>
                  <div class="w-[40%] truncate text-orange-600 text-sm font-medium text-left" title="${awayName}">
                    ${awayOddsDisplay} ${awayPredBadge} ${awayName} ${awayFavIcon}
                  </div>
                </div>
                ${setsSmall}
              </div>`;
        });

      cnt.innerHTML = `
        <div class="sm:hidden rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">${mobileHtml}</div>
        <div class="hidden sm:block rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden sm:overflow-x-visible mt-3 sm:mt-0">
          <table class="w-full">
            <thead class="sticky top-0 bg-slate-50 text-[11px] font-semibold text-slate-600 z-10">
              <tr>
                <th scope="col" class="px-3 sm:px-4 py-2 text-left">Tarih/Saat</th>
                <th scope="col" class="px-3 sm:px-4 py-2 text-left">Turnuva</th>
                <th scope="col" class="px-3 sm:px-4 py-2 text-center">TGS</th>
                <th scope="col" class="px-3 sm:px-4 py-2 text-right">Ev Sahibi</th>
                <th scope="col" class="px-3 sm:px-4 py-2 text-center">Skor</th>
                <th scope="col" class="px-3 sm:px-4 py-2 text-left">Deplasman</th>
              </tr>
            </thead>
            <tbody class="text-sm text-slate-800">${rowsHtml}</tbody>
          </table>
        </div>`;
      
      Array.from(cnt.querySelectorAll('[data-eid]')).forEach((el) => {
        const eid = Number(el.getAttribute('data-eid'));
        const ev = events.find(x => x.id === eid);
        if (!ev) return;
        el.addEventListener('click', () => openModal(ev));
        if(el.tagName === 'TR') {
            el.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openModal(ev); } });
        }
      });
    } catch (err) { status.textContent = "Veri alınırken hata oluştu."; console.error("API hatası:", err); }
}


  const btnLive = document.getElementById("btnLive"); const btnFinished = document.getElementById("btnFinished"); const btnUpcoming = document.getElementById("btnUpcoming");
  function setBtns(active) {
    btnLive.className = active === 'live' ? "px-3 py-1 rounded-full bg-indigo-600 text-white" : "px-3 py-1 rounded-full text-slate-700 hover:bg-white";
    btnFinished.className = active === 'finished' ? "px-3 py-1 rounded-full bg-indigo-600 text-white" : "px-3 py-1 rounded-full text-slate-700 hover:bg-white";
    btnUpcoming.className = active === 'upcoming' ? "px-3 py-1 rounded-full bg-indigo-600 text-white" : "px-3 py-1 rounded-full text-slate-700 hover:bg-white";
  }
  btnLive.addEventListener("click", () => { currentFilter = 'live'; setBtns('live'); loadMatches(); });
  btnFinished.addEventListener("click", () => { currentFilter = 'finished'; setBtns('finished'); loadMatches(); });
  btnUpcoming.addEventListener("click", () => { currentFilter = 'upcoming'; setBtns('upcoming'); loadMatches(); });
  document.getElementById("refreshBtn").addEventListener("click", () => loadMatches());

  setInterval(loadMatches, 60000);
  loadMatches();
</script>
</body>
</html>